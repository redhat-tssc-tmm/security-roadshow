# Containerfile using Red Hat UBI9 with ttyd binary
FROM registry.access.redhat.com/ubi9/ubi:latest

USER root

# Install required packages using dnf (RHEL/UBI package manager)
RUN dnf update -y && dnf install -y \
    wget \
    git \
    bash-completion \
    nano \
    vim \
    jq \
    python3-pip \
    podman \
    fuse-overlayfs \
    slirp4netns \
    && dnf clean all

# Download and install ttyd binary
RUN curl -L https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd.x86_64 \
    -o /usr/local/bin/ttyd && \
    chmod +x /usr/local/bin/ttyd

# Download and install oc CLI - oc only, no kubectl
RUN curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz \
    | tar -xzC /usr/local/bin/ oc \
    && chmod +x /usr/local/bin/oc

# Download and install syft binary
RUN curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

# Download and install roxctl binary
RUN curl -L https://mirror.openshift.com/pub/rhacs/assets/latest/bin/linux/roxctl \
    -o /usr/local/bin/roxctl && \
    chmod +x /usr/local/bin/roxctl

# Create student user
RUN groupadd -g 1001 student && \
    useradd -u 1001 -g student -m -s /bin/bash student

# Configure subordinate UIDs and GIDs for rootless podman
RUN echo "student:100000:65536" > /etc/subuid && \
    echo "student:100000:65536" > /etc/subgid

# Create workspace and oc config directories
RUN mkdir -p /workspace /home/student/.kube && \
    chown -R student:student /workspace /home/student

# Configure rootless podman for student user
RUN mkdir -p /home/student/.config/containers && \
    echo -e '[storage]\ndriver = "overlay"\n[storage.options.overlay]\nmount_program = "/usr/bin/fuse-overlayfs"' > /home/student/.config/containers/storage.conf && \
    chown -R student:student /home/student/.config

# Copy scripts and configuration files
COPY --chown=student:student configure-oc.sh /home/student/configure-oc.sh
COPY --chown=student:student setup-tas-tools.sh /home/student/setup-tas-tools.sh
COPY --chown=student:student setup-tas-environment.sh /home/student/setup-tas-environment.sh
COPY --chown=student:student student-bashrc-additions.sh /home/student/.bashrc-additions
COPY --chown=root:root terminal-reset /usr/local/bin/terminal-reset

# Set up bash profile and make scripts executable
RUN cat /home/student/.bashrc-additions >> /home/student/.bashrc && \
    rm /home/student/.bashrc-additions && \
    chmod +x /home/student/configure-oc.sh && \
    chmod +x /home/student/setup-tas-tools.sh && \
    chmod +x /home/student/setup-tas-environment.sh && \
    chmod +x /usr/local/bin/terminal-reset

USER student
WORKDIR /workspace

EXPOSE 7681

ENTRYPOINT ["/home/student/configure-oc.sh"]